#!/bin/sh

# enable extended globbing
# especially useful for !(pattern)
shopt -s extglob

# Utils {{{
green() {
    echo -e "$(tput setaf 2)> $1$(tput sgr0)"
}

realpath() {
    if [[ $(uname -s) == 'Darwin' ]]; then
        [[ $1 == /* ]] && echo "$1" || echo "$PWD/${1#./}"
    else
        /usr/bin/realpath "$1"
    fi
}

func_name() {
    echo ${FUNCNAME[1]} | cut -d'_' -f2-
}

get_configs() {
    grep -oE "^config_[a-z0-9_]+" $0 | sed 's/config_//g' | sort
}

help() {
    echo -e "Usage: $0 <foo>\n"
    echo "Can configure the following:" && get_configs
}
# }}}

# XDG-compliant {{{

config_starship() {
    green $(func_name)

    ln -sf $(realpath ./.config/starship) ~/.config/
}

config_nvim() {
    green $(func_name)

    cfg_dir=~/.config/nvim
    data_dir=~/.local/share/nvim

    rm -rf $cfg_dir $data_dir
    mkdir -p $cfg_dir $data_dir

    ln -s $(realpath vim/.vimrc) $cfg_dir/init.vim
    find vim/* -type d -exec ln -s $(realpath {}) $cfg_dir \;

    curl -fLo $data_dir/site/autoload/plug.vim --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

    nvim +PlugInstall +qall
}

config_gnu_emacs() {
    green $(func_name)

    rm -rf ~/.config/emacs
    ln -s $(realpath ./.config/emacs) ~/.config
}

config_doom_emacs() {
    green $(func_name)

    rm -rf ~/.config/emacs
    rm -rf ~/.config/doom

    git clone --depth 1 https://github.com/hlissner/doom-emacs ~/.config/emacs
    ~/.config/emacs/bin/doom install

    rm -rf ~/.config/doom
    ln -s $(realpath .config/doom) ~/.config

    ~/.config/emacs/bin/doom sync
}

config_irb() {
    green $(func_name)

    rm -rf ~/.config/irb
    ln -s $(realpath ./.config/irb) ~/.config
    mkdir -p ~/.local/share/irb

    gem install irbtools
}

config_rlang() {
    green $(func_name)

    rm -rf ~/.config/R
    ln -s $(realpath ./.config/R) ~/.config
    mkdir -p ~/.local/share/R
}

config_gdb() {
    green $(func_name)

    rm -rf ~/.config/gdb
    ln -s $(realpath ./.config/gdb) ~/.config
}

config_npm() {
    green $(func_name)

    rm -rf ~/.config/npm
    ln -s $(realpath ./.config/npm) ~/.config
}

config_tmux() {
    green $(func_name)

    rm -rf ~/.config/tmux
    ln -s $(realpath ./.config/tmux) ~/.config
}

config_zathura() {
    green $(func_name)

    rm -rf ~/.config/zathura
    ln -s $(realpath ./.config/zathura) ~/.config/
}

config_sioyek() {
    green $(func_name)

    rm -rf ~/.config/sioyek
    ln -s $(realpath ./.config/sioyek) ~/.config/
}

config_conda() {
    green $(func_name)

    rm -rf ~/.config/conda
    ln -s $(realpath ./.config/conda) ~/.config
}

config_kitty() {
    green $(func_name)

    rm -rf ~/.config/kitty
    ln -s $(realpath ./.config/kitty) ~/.config
}

config_i3() {
    green $(func_name)

    for f in i3 compton dunst; do
        rm -rf ~/.config/$f
        ln -s $(realpath ./.config/$f) ~/.config
    done
}

config_rofi() {
    green $(func_name)

    rm -rf ~/.config/rofi
    ln -s $(realpath ./.config/rofi) ~/.config
}

config_htop() {
    green $(func_name)

    rm -rf ~/.config/htop
    ln -s $(realpath ./.config/htop) ~/.config/
}

config_git() {
    green $(func_name)

    git config --global init.defaultBranch main
    git config --global core.fileMode false
    git config --global core.editor vim
    git config --global core.eol lf
}

config_symlinks() {
    green $(func_name)

    mkdir -p ~/.local/bin

    for f in ./.local/bin/*; do
        green "Adding symlink to ~/.local/bin/: $f"
        ln -sf $(realpath "$f") ~/.local/bin
    done

    for f in ./.local/share/*; do
        green "Adding symlink to ~/.local/share/: $f"
        ln -s $(realpath "$f") ~/.local/share
    done

    green "Adding symlink to ~/: .xbindkeysrc"
    ln -sf $(realpath ./.config/.xbindkeysrc) ~/
    xbindkeys --poll-rc
}
# }}}

# Others {{{

config_zsh() {
    green $(func_name)

    cfg_dir=$HOME/.zsh/simple-zsh

    rm ~/.zshrc ~/.zshenv
    rm -rf ~/.config/fzf

    for f in $cfg_dir ~/.zsh/cache; do
        rm -rf $f && mkdir -p $f
    done

    git clone --depth=1 --recurse-submodules --remote-submodules \
        https://github.com/alexandru-dinu/simple-zsh.git $cfg_dir

    cp sh/.zshrc ~/
    cp sh/.zshenv ~/

    exec zsh -i -c "echo Done!; exit"
}

config_bash() {
    green $(func_name)

    cp sh/.bashrc ~/
}

config_vim() {
    green $(func_name)

    rm -rf ~/.vim* && mkdir -p ~/.vim

    ln -s $(realpath vim/.vimrc) ~/
    find vim/* -type d -exec ln -s $(realpath {}) ~/.vim/ \;

    curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

    vim +PlugInstall +qall
}

config_vifm() {
    green $(func_name)

    rm -rf ~/.config/vifm
    ln -s $(realpath ./.config/vifm) ~/.config
}

config_ghci() {
    green $(func_name)

    rm -f ~/.ghci
    ln -s $(realpath ghci/.ghci) ~/.ghci
    chmod go-w ~/.ghci
}

config_vscode() {
    green $(func_name)

    cfg_dir=~/.config/Code/User
    ext_dir=~/.vscode/extensions

    rm -rf ~/.vscode ~/.config/Code
    mkdir -p $cfg_dir

    declare -a configs=("keybindings.json" "settings.json" "snippets")

    for c in "${configs[@]}"; do
        ln -s $(realpath vscode/$c) $cfg_dir/
    done
}

config_pycharm() {
    green $(func_name)

    select cfg_dir in $(find ~/.config/JetBrains -name "PyCharm*"); do
        echo "Selected $cfg_dir"; break;
    done

    for d in ./.config/pycharm/!(options); do
        f="$(basename "$d")"
        rm -rf "${cfg_dir:?}/$f"
        ln -s "$(realpath "$d")" "${cfg_dir:?}/$f"
    done

    for o in ./.config/pycharm/options/*; do
        f="$(basename "$o")"
        rm -rf "${cfg_dir:?}/options/$f"
        ln -s "$(realpath "$o")" "${cfg_dir:?}/options/$f"
    done
}

config_mxmaster() {
    green $(func_name)

    sudo ln -sf $(realpath ./extra/mxmaster/logid.cfg) /etc/
    sudo systemctl restart logid.service
}

config_jupyter() {
    green $(func_name)

    ln -sf $(realpath jupyter/custom) ~/.jupyter
    ln -sf $(realpath jupyter/lab/user-settings) ~/.jupyter/lab
}

config_ipython() {
    green $(func_name)

    cfg_dir=~/.ipython/profile_default
    mkdir -p $cfg_dir
    ln -sf $(realpath python/ipython_config.py) $cfg_dir
    ln -sf $(realpath python/startup) $cfg_dir
}

config_ptpython() {
    green $(func_name)

    cfg_dir=~/.config/ptpython
    mkdir -p $cfg_dir
    ln -sf $(realpath python/ptpython_config.py) $cfg_dir/config.py
}

config_cinnamon() {
    green $(func_name)

    js_dir="/usr/share/cinnamon/js/ui"

    dconf load /org/cinnamon/ < ./extra/cinnamon/cinnamon.dconf

    sudo vim ${js_dir}/workspacesView.js
    sudo vim ${js_dir}/windowManager.js
}
# }}}

case "$1" in
"" | --help | -h)
    help
    ;;
--list | -l)
    get_configs
    ;;
*)
    for item in "$@"; do
        if get_configs | grep -qw "$item"; then
            config_"$item"
        else
            echo "No config for $item"
        fi
    done
    ;;
esac

# vim:foldmethod=marker:foldlevel=0
