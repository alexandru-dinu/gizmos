#!/bin/bash

# enable extended globbing
# especially useful for !(pattern)
shopt -s extglob

green=$(tput setaf 2)
red=$(tput setaf 1)
reset=$(tput sgr0)

prompt() {
    echo -e "${green}> $1${reset}"
}

red_prompt() {
    echo -e "${red}> $1${reset}"
}

realpath() {
    if [[ $(uname -s) == 'Darwin' ]]; then
        [[ $1 == /* ]] && echo "$1" || echo "$PWD/${1#./}"
    else
        /usr/bin/realpath "$1"
    fi
}

func_name() {
    echo ${FUNCNAME[1]} | cut -d'_' -f2-
}

config_zsh() {
    prompt $(func_name)

    cfg_dir=$HOME/.zsh/simple-zsh

    rm -rf ~/.zshrc ~/.zshenv ~/.fzf*

    for f in $cfg_dir ~/.zsh/cache; do
        rm -rf $f && mkdir -p $f
    done

    git clone --depth=1 --recurse-submodules --remote-submodules \
        https://github.com/alexandru-dinu/simple-zsh.git $cfg_dir

    cp sh/.zshrc ~/
    cp sh/.zshenv ~/

    exec zsh -i -c "echo Done!; exit"
}

config_bash() {
    prompt $(func_name)

    cp sh/.bashrc ~/
}

config_starship() {
    prompt $(func_name)

    ln -sf $(realpath starship/starship.toml) ~/.config/
}

config_vim() {
    prompt $(func_name)

    rm -rf ~/.vim* && mkdir -p ~/.vim

    ln -s $(realpath vim/.vimrc) ~/
    find vim/* -type d -exec ln -s $(realpath {}) ~/.vim/ \;

    curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

    vim +PlugInstall +qall
}

config_nvim() {
    prompt $(func_name)

    cfg_dir=~/.config/nvim
    data_dir=~/.local/share/nvim

    rm -rf $cfg_dir $data_dir
    mkdir -p $cfg_dir $data_dir

    ln -s $(realpath vim/.vimrc) $cfg_dir/init.vim
    find vim/* -type d -exec ln -s $(realpath {}) $cfg_dir \;

    curl -fLo $data_dir/site/autoload/plug.vim --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

    nvim +PlugInstall +qall
}

config_vifm() {
    prompt $(func_name)

    cfg_dir=~/.config/vifm

    rm -rf $cfg_dir
    ln -s $(realpath vifm) $cfg_dir
}

config_gnu_emacs() {
    prompt $(func_name)

    cfg_dir=~/.emacs.d

    rm -rf $cfg_dir && mkdir -p $cfg_dir
    ln -s $(realpath emacs/gnu/init.el) $cfg_dir/
}

config_doom_emacs() {
    prompt $(func_name)

    cfg_dir=~/.emacs.d

    rm -rf $cfg_dir ~/.doom.d

    git clone --depth 1 https://github.com/hlissner/doom-emacs $cfg_dir
    $cfg_dir/bin/doom install

    rm -rf ~/.doom.d
    ln -sf $(realpath emacs/.doom.d) ~/
    $cfg_dir/bin/doom sync

    $cfg_dir/bin/doom doctor
}

config_ghci() {
    prompt $(func_name)

    rm -f ~/.ghci
    ln -s $(realpath ghci/.ghci) ~/.ghci
    chmod go-w ~/.ghci
}

config_ruby() {
    prompt $(func_name)

    gem install irbtools

    rm -f ~/.irbrc
    ln -s $(realpath ruby/.irbrc) ~/.irbrc
    chmod go-w ~/.irbrc
}

config_rlang() {
    prompt $(func_name)

    declare -a configs=(".Renviron" ".Rprofile")
    for f in "${configs[@]}"; do
        rm -f ~/$f && ln -s $(realpath r-lang/$f) ~/
    done
}

config_gdb() {
    prompt $(func_name)

    rm -rf ~/peda.git ~/.gdbinit
    git clone --depth=1 https://github.com/longld/peda.git ~/peda.git
    ln -s $(realpath gdb/.gdbinit) ~/.gdbinit
}

config_tmux() {
    prompt $(func_name)

    rm -f ~/.tmux.conf
    ln -s $(realpath tmux/.tmux.conf) ~/.tmux.conf
}

config_zathura() {
    prompt $(func_name)

    rm -rf ~/.config/zathura
    ln -s $(realpath zathura) ~/.config/
}

config_sioyek() {
    prompt $(func_name)

    rm -rf ~/.config/sioyek
    ln -s $(realpath sioyek) ~/.config/
}

config_vscode() {
    prompt $(func_name)

    cfg_dir=~/.config/Code/User
    ext_dir=~/.vscode/extensions

    rm -rf ~/.vscode ~/.config/Code
    mkdir -p $cfg_dir

    declare -a configs=("keybindings.json" "settings.json" "snippets")

    for c in "${configs[@]}"; do
        ln -s $(realpath vscode/$c) $cfg_dir/
    done
}

config_pycharm() {
    prompt $(func_name)

    cfg_dir=$(find ~/.config/JetBrains -name "PyCharm*" 2>/dev/null | head -n 1)

    echo "Found $cfg_dir"

    for d in jetbrains/pycharm/!(options); do
        f="$(basename "$d")"
        rm -rf "${cfg_dir:?}/$f"
        ln -s "$(realpath "$d")" "${cfg_dir:?}/$f"
    done

    for o in jetbrains/pycharm/options/*; do
        f="$(basename "$o")"
        rm -rf "${cfg_dir:?}/options/$f"
        ln -s "$(realpath "$o")" "${cfg_dir:?}/options/$f"
    done
}

config_conda() {
    prompt $(func_name)

    ln -sf $(realpath conda/.condarc) ~/.condarc
}

config_jupyter() {
    prompt $(func_name)

    ln -sf $(realpath jupyter/custom) ~/.jupyter
    ln -sf $(realpath jupyter/lab/user-settings) ~/.jupyter/lab
}

config_kitty() {
    prompt $(func_name)

    cfg_dir=~/.config/kitty

    rm -rf $cfg_dir && mkdir -p $cfg_dir
    ln -s $(realpath kitty/kitty.conf) $cfg_dir
}

config_i3() {
    prompt $(func_name)

    rm -rf ~/.config/i3 ~/.config/compton
    mkdir -p ~/.config/i3 ~/.config/compton

    declare -a configs=("config" "i3status.conf")

    for c in "${configs[@]}"; do
        ln -s $(realpath i3/$c) ~/.config/i3/
    done

    mkdir -p ~/.config/compton
    ln -s $(realpath i3/compton.conf) ~/.config/compton/config

    mkdir -p ~/.config/dunst
    ln -sf $(realpath i3/dunstrc) ~/.config/dunst/

    for f in i3/bin/*; do
        sudo cp --remove-destination "$f" /usr/bin/ &&
        sudo chown "$USER":"$USER" /usr/bin/"$(basename "$f")" &&
        sudo chmod +x /usr/bin/"$(basename "$f")"
    done
}

config_rofi() {
    prompt $(func_name)

    cfg_dir=~/.config/rofi

    rm -rf ${cfg_dir} && mkdir -p ${cfg_dir}
    ln -s $(realpath rofi/config.rasi) ${cfg_dir}
}

config_mxmaster() {
    prompt $(func_name)

    sudo ln -sf $(realpath mx-master/logid.cfg) /etc/
    sudo systemctl restart logid.service
}

config_ipython() {
    prompt $(func_name)

    cfg_dir=~/.ipython/profile_default
    mkdir -p $cfg_dir
    ln -sf $(realpath python/ipython_config.py) $cfg_dir
    ln -sf $(realpath python/startup) $cfg_dir
}

config_ptpython() {
    prompt $(func_name)

    cfg_dir=~/.config/ptpython
    mkdir -p $cfg_dir
    ln -sf $(realpath python/ptpython_config.py) $cfg_dir/config.py
}

config_htop() {
    prompt $(func_name)

    cfg_dir=~/.config/htop
    rm -rf $cfg_dir && ln -s $(realpath htop) $cfg_dir
}

config_git() {
    prompt $(func_name)

    git config --global init.defaultBranch main
    git config --global core.fileMode false
    git config --global core.editor vim
    git config --global core.eol lf
}

config_firefox() {
    prompt $(func_name)

    python firefox/patch.py
}

config_cinnamon() {
    prompt $(func_name)

    js_dir="/usr/share/cinnamon/js/ui"

    dconf load /org/cinnamon/ < ./cinnamon/cinnamon.dconf

    sudo vim ${js_dir}/workspacesView.js
    sudo vim ${js_dir}/windowManager.js
}

config_gestures() {
    prompt $(func_name)

    conf="libinput-gestures.conf"

    sudo ln -s $(realpath gestures/${conf}) /etc/${conf}
    ln -s $(realpath gestures/${conf}.home) ~/.config/${conf}
}

config_symlinks() {
    prompt $(func_name)

    mkdir -p ~/.local/bin

    for f in tools/bin/*; do
        prompt "Adding symlink to ~/.local/bin/: $f"
        ln -sf $(realpath "$f") ~/.local/bin
    done

    prompt "Adding symlink to ~/: .xbindkeysrc"
    ln -sf $(realpath tools/.xbindkeysrc) ~/
    xbindkeys --poll-rc
}

get_configs() {
    grep -oE "^config_[a-z0-9_]+" $0 | sed 's/config_//g' | sort
}

help() {
    echo -e "Usage: $0 <foo>\n"
    echo "Can configure the following:" && get_configs
}

case "$1" in
"" | --help | -h)
    help
    ;;
--list | -l)
    get_configs
    ;;
*)
    for item in "$@"; do
        if get_configs | grep -qw "$item"; then
            config_"$item"
        else
            red_prompt "No config for $item"
        fi
    done
    ;;
esac
